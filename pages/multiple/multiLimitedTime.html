<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Server Time-Limited Simulation</title>
    <!-- Global layout & buttons -->
    <link rel="stylesheet" href="../../css/main.css">
    <!-- Simulation-specific layout (tables, inputs, etc.) -->
    <link rel="stylesheet" href="../../css/simulation.css">
    <!-- Multi-Limited Time specific styles -->
    <link rel="stylesheet" href="../../css/multiLimitedTime.css">
</head>
<body>
<div class="container">
        <button class="btn back-btn" onclick="window.location.href='../../index.html'">‚Üê Back to Main Menu</button>
        
        <h1>Multi-Server Time-Limited Simulation</h1>

        <!-- Tabs Navigation -->
        <div class="tabs-nav">
            <button class="tab-btn active" onclick="switchTab(0)">Step 1 ‚Äî Rule & Time Limit</button>
            <button class="tab-btn" onclick="switchTab(1)">Step 2 ‚Äî Interarrivals</button>
            <button class="tab-btn" onclick="switchTab(2)">Step 3 ‚Äî Service Times</button>
            <button class="tab-btn" onclick="switchTab(3)">Step 4 ‚Äî Random Numbers</button>
            <button class="tab-btn" onclick="switchTab(4)">Step 5 ‚Äî Simulation Table</button>
        </div>

        <!-- TAB 1: Rule & Time Limit -->
        <div id="tab0" class="tab-content active">
            <div class="tab-body">
                <h2>Step 1: Rule & Time Limit</h2>
                <p>When multiple servers are idle, who should take the call first?</p>
                
                <div class="radio-group">
                    <label>
                        <input type="radio" name="preference" value="Faster" checked>
                        Faster server first
                    </label>
                    <label>
                        <input type="radio" name="preference" value="Slower">
                        Slower server first
                    </label>
                </div>

                <div class="input-group">
                    <label>Number of Servers:</label>
                    <input type="number" id="numServers" min="2" max="10" value="2" placeholder="e.g., 2" onchange="updateServerCount()">
                    <small>(Minimum 2 servers required)</small>
                </div>

                <div class="input-group">
<label>Select Limitation Type:</label>
<select id="limitType">
<option value="arrival">Limited by Arrival Time</option>
<option value="serviceEnd">Limited by Service End Time</option>
<option value="both">Strict Limited (Arrival + Service End)</option>
</select>
</div>

                <div class="input-group">
                    <label>Time Limit:</label>
                    <input type="number" id="timeLimit" min="0.1" step="0.1" placeholder="e.g., 100.0">
                    <small>(Simulation will stop when this time limit is reached)</small>
                </div>

                <button class="btn btn-primary" onclick="nextTab(1)">Next ‚Üí Step 2</button>
            </div>
        </div>

        <!-- TAB 2: Arrivals -->
        <div id="tab1" class="tab-content">
            <div class="tab-body">
                <h2>Step 2: Time Between Arrivals</h2>
                <p>Fill in the table directly with Time and Probability values. Cumulative and Interval will be calculated automatically.</p>
                
                <div class="table-container">
                    <div class="table-controls">
                        <button class="btn-add-row" onclick="addArrivalRow()">Add Row</button>
                        <input type="number" id="arrivalRowCount" min="1" max="50" value="3" placeholder="Rows" style="width: 80px; margin: 0 5px; padding: 5px;">
                        <button class="btn btn-secondary" onclick="generateArrivalRows()">Generate Rows</button>
                    </div>
                    
                    <textarea id="txtArrivals" rows="4" placeholder="Alternative: Enter time,prob (one per line)&#10;1,0.25&#10;2,0.40&#10;3,0.35" style="margin-bottom: 15px; display: none;"></textarea>

                    <h3>Arrival Table (Time | Probability | Cumulative | Interval 01‚Äì100)</h3>
                    <table id="tableArrival" class="editable-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"></th>
                                <th>Time</th>
                                <th>Probability</th>
                                <th>Cumulative</th>
                                <th>Interval</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyArrival">
                            <tr>
                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteArrivalRow(this)" title="Delete row">üóëÔ∏è</button></td>
                                <td><input type="number" class="table-input" step="0.1" min="0" placeholder="Time" onchange="calculateArrivalTable()"></td>
                                <td><input type="number" class="table-input" step="0.01" min="0" max="1" placeholder="Prob" onchange="calculateArrivalTable()"></td>
                                <td class="calculated-cell"></td>
                                <td class="calculated-cell"></td>
                            </tr>
                            <tr>
                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteArrivalRow(this)" title="Delete row">üóëÔ∏è</button></td>
                                <td><input type="number" class="table-input" step="0.1" min="0" placeholder="Time" onchange="calculateArrivalTable()"></td>
                                <td><input type="number" class="table-input" step="0.01" min="0" max="1" placeholder="Prob" onchange="calculateArrivalTable()"></td>
                                <td class="calculated-cell"></td>
                                <td class="calculated-cell"></td>
                            </tr>
                            <tr>
                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteArrivalRow(this)" title="Delete row">üóëÔ∏è</button></td>
                                <td><input type="number" class="table-input" step="0.1" min="0" placeholder="Time" onchange="calculateArrivalTable()"></td>
                                <td><input type="number" class="table-input" step="0.01" min="0" max="1" placeholder="Prob" onchange="calculateArrivalTable()"></td>
                                <td class="calculated-cell"></td>
                                <td class="calculated-cell"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevTab(0)">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="nextTab(2)">Next ‚Üí Step 3</button>
                </div>
            </div>
        </div>

        <!-- TAB 3: Service Times -->
        <div id="tab2" class="tab-content">
            <div class="tab-body">
                <h2>Step 3: Service Times</h2>
                <p>Fill in service time tables for each server. Tables will be created based on the number of servers specified in Step 1.</p>
                
                <div id="serviceContainer" class="service-container">
                    <!-- Service tables will be dynamically generated here -->
                </div>

                <div id="speedDetection" class="alert hidden"></div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevTab(1)">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="nextTab(3)">Next ‚Üí Step 4</button>
                </div>
            </div>
        </div>

        <!-- TAB 4: Random Numbers -->
        <div id="tab3" class="tab-content">
            <div class="tab-body">
                <h2>Step 4: Random Numbers</h2>
                <p>Choose how to provide random numbers for each table: Manual Input or Generated (LCG/Mid-Square)</p>

                <div class="random-tables-container">
                    <div class="random-table-box">
                        <h4>Arrival Random Numbers (for customers 2..N)</h4>

                        <!-- Arrival Method Selection -->
                        <div class="table-method-selector">
                            <div class="method-tabs">
                                <button class="method-tab active" onclick="switchTableMethod('arrival', 'manual')" id="tabArrivalManual">Manual Input</button>
                                <button class="method-tab" onclick="switchTableMethod('arrival', 'generated')" id="tabArrivalGenerated">Generated</button>
                            </div>
                        </div>

                        <!-- Manual Input Section for Arrival -->
                        <div id="arrivalManualSection" class="table-method-section active">
                            <div class="table-controls">
                                <button class="btn-add-row" onclick="addRandomNumberRow('arrival')">Add Row</button>
                                <input type="number" id="randomArrivalRowCount" min="1" max="100" value="5" placeholder="Rows" style="width: 80px; margin: 0 5px; padding: 5px;">
                                <button class="btn btn-secondary" onclick="generateRandomNumberRows('arrival')">Generate Rows</button>
                                <button class="btn btn-secondary" onclick="updateRandomNumberCounts()">Update Count</button>
                            </div>
                            <div class="table-container">
                                <table id="tableRnArr" class="editable-table random-numbers-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;"></th>
                                            <th>Random Number</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyRnArr">
                                        <tr>
                                            <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'arrival')" title="Delete row">üóëÔ∏è</button></td>
                                            <td><input type="number" class="table-input" min="1" max="100" placeholder="1-100"></td>
                                        </tr>
                                        <tr>
                                            <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'arrival')" title="Delete row">üóëÔ∏è</button></td>
                                            <td><input type="number" class="table-input" min="1" max="100" placeholder="1-100"></td>
                                        </tr>
                                        <tr>
                                            <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'arrival')" title="Delete row">üóëÔ∏è</button></td>
                                            <td><input type="number" class="table-input" min="1" max="100" placeholder="1-100"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Generated Section for Arrival -->
                        <div id="arrivalGeneratedSection" class="table-method-section">
                            <div class="generation-method-selector">
                                <label class="radio-label">
                                    <input type="radio" name="arrivalGenMethod" value="LCG" checked onchange="switchGenMethod('arrival', 'LCG')">
                                    <span>Linear Congruential Generator (LCG)</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="arrivalGenMethod" value="MidSquare" onchange="switchGenMethod('arrival', 'MidSquare')">
                                    <span>Mid-Square Method</span>
                                </label>
                            </div>

                            <!-- LCG Parameters for Arrival -->
                            <div id="arrivalLcgParams" class="gen-params">
                                <h4>LCG Parameters</h4>
                                <div class="params-grid">
                                    <div class="input-group">
                                        <label>Multiplier (a):</label>
                                        <input type="number" id="arrivalLcgA" min="0" placeholder="e.g., 1664525">
                                    </div>
                                    <div class="input-group">
                                        <label>Increment (c):</label>
                                        <input type="number" id="arrivalLcgC" min="0" placeholder="e.g., 1013904223">
                                    </div>
                                    <div class="input-group">
                                        <label>Modulus (m):</label>
                                        <input type="number" id="arrivalLcgM" min="1" placeholder="e.g., 2^32">
                                    </div>
                                    <div class="input-group">
                                        <label>Initial Seed (Z‚ÇÄ):</label>
                                        <input type="number" id="arrivalLcgSeed" min="0" placeholder="e.g., 12345">
                                    </div>
                                </div>
                            </div>

                            <!-- Mid-Square Parameters for Arrival -->
                            <div id="arrivalMidSquareParams" class="gen-params hidden">
                                <h4>Mid-Square Parameters</h4>
                                <div class="input-group">
                                    <label>Seed (4-digit, 1000-9999):</label>
                                    <input type="number" id="arrivalMidSquareSeed" min="1000" max="9999" placeholder="e.g., 1234">
                                </div>
                            </div>

                            <div class="input-group">
                                <label>Number of Arrival Random Numbers:</label>
                                <input type="number" id="genArrCount" min="1" placeholder="e.g., 50">
                                <small>For customers 2..N (recommended: enough for time limit)</small>
                            </div>

                            <button class="btn btn-secondary" onclick="generateTableRandomNumbers('arrival')">Generate Arrival Numbers</button>

                            <div id="arrivalGeneratedResults" class="generated-results hidden">
                                <h4>Generated Arrival Numbers</h4>
                                <textarea id="genArrNumbers" rows="3" readonly></textarea>
                                <button class="btn btn-secondary" onclick="useGeneratedTableNumbers('arrival')">Use These Numbers</button>
                            </div>
                        </div>

                        <small id="arrivalCount">Count: 3 numbers</small>
                    </div>

                    <div class="random-table-box">
                        <h4>Service Random Numbers (for all servers, shared list)</h4>

                        <!-- Service Method Selection -->
                        <div class="table-method-selector">
                            <div class="method-tabs">
                                <button class="method-tab active" onclick="switchTableMethod('service', 'manual')" id="tabServiceManual">Manual Input</button>
                                <button class="method-tab" onclick="switchTableMethod('service', 'generated')" id="tabServiceGenerated">Generated</button>
                            </div>
                        </div>

                        <!-- Manual Input Section for Service -->
                        <div id="serviceManualSection" class="table-method-section active">
                            <div class="table-controls">
                                <button class="btn-add-row" onclick="addRandomNumberRow('service')">Add Row</button>
                                <input type="number" id="randomServiceRowCount" min="1" max="100" value="5" placeholder="Rows" style="width: 80px; margin: 0 5px; padding: 5px;">
                                <button class="btn btn-secondary" onclick="generateRandomNumberRows('service')">Generate Rows</button>
                                <button class="btn btn-secondary" onclick="updateRandomNumberCounts()">Update Count</button>
                            </div>
                            <div class="table-container">
                                <table id="tableRnServ" class="editable-table random-numbers-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;"></th>
                                            <th>Random Number</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyRnServ">
                                        <tr>
                                            <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'service')" title="Delete row">üóëÔ∏è</button></td>
                                            <td><input type="number" class="table-input" min="1" max="100" placeholder="1-100"></td>
                                        </tr>
                                        <tr>
                                            <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'service')" title="Delete row">üóëÔ∏è</button></td>
                                            <td><input type="number" class="table-input" min="1" max="100" placeholder="1-100"></td>
                                        </tr>
                                        <tr>
                                            <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'service')" title="Delete row">üóëÔ∏è</button></td>
                                            <td><input type="number" class="table-input" min="1" max="100" placeholder="1-100"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Generated Section for Service -->
                        <div id="serviceGeneratedSection" class="table-method-section">
                            <div class="generation-method-selector">
                                <label class="radio-label">
                                    <input type="radio" name="serviceGenMethod" value="LCG" checked onchange="switchGenMethod('service', 'LCG')">
                                    <span>Linear Congruential Generator (LCG)</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="serviceGenMethod" value="MidSquare" onchange="switchGenMethod('service', 'MidSquare')">
                                    <span>Mid-Square Method</span>
                                </label>
                            </div>

                            <!-- LCG Parameters for Service -->
                            <div id="serviceLcgParams" class="gen-params">
                                <h4>LCG Parameters</h4>
                                <div class="params-grid">
                                    <div class="input-group">
                                        <label>Multiplier (a):</label>
                                        <input type="number" id="serviceLcgA" min="0" placeholder="e.g., 1664525">
                                    </div>
                                    <div class="input-group">
                                        <label>Increment (c):</label>
                                        <input type="number" id="serviceLcgC" min="0" placeholder="e.g., 1013904223">
                                    </div>
                                    <div class="input-group">
                                        <label>Modulus (m):</label>
                                        <input type="number" id="serviceLcgM" min="1" placeholder="e.g., 2^32">
                                    </div>
                                    <div class="input-group">
                                        <label>Initial Seed (Z‚ÇÄ):</label>
                                        <input type="number" id="serviceLcgSeed" min="0" placeholder="e.g., 12345">
                                    </div>
                                </div>
                            </div>

                            <!-- Mid-Square Parameters for Service -->
                            <div id="serviceMidSquareParams" class="gen-params hidden">
                                <h4>Mid-Square Parameters</h4>
                                <div class="input-group">
                                    <label>Seed (4-digit, 1000-9999):</label>
                                    <input type="number" id="serviceMidSquareSeed" min="1000" max="9999" placeholder="e.g., 1234">
                                </div>
                            </div>

                            <div class="input-group">
                                <label>Number of Service Random Numbers:</label>
                                <input type="number" id="genServCount" min="1" placeholder="e.g., 50">
                                <small>For all servers (recommended: enough for time limit)</small>
                            </div>

                            <button class="btn btn-secondary" onclick="generateTableRandomNumbers('service')">Generate Service Numbers</button>

                            <div id="serviceGeneratedResults" class="generated-results hidden">
                                <h4>Generated Service Numbers</h4>
                                <textarea id="genServNumbers" rows="3" readonly></textarea>
                                <button class="btn btn-secondary" onclick="useGeneratedTableNumbers('service')">Use These Numbers</button>
                            </div>
                        </div>

                        <small id="serviceCount">Count: 3 numbers</small>
                    </div>
                </div>

                <!-- Hidden textareas for backward compatibility -->
                <textarea id="txtRnArr" style="display: none;"></textarea>
                <textarea id="txtRnServ" style="display: none;"></textarea>

                <div class="button-group" style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="runSimulationFromUI()">Run Simulation ‚Üí Show Results (Step 5)</button>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevTab(2)">‚Üê Back</button>
                </div>
            </div>
</div>

       <!-- TAB 5: Results -->
<div id="tab4" class="tab-content">
    <div class="tab-body">
        <h2>Step 5: Simulation Results</h2>

        <!-- ‚úÖ INCLUDED IN PDF -->
        <div id="report">

            <div id="speedInfo" class="alert hidden"></div>
            <div id="timeLimitInfo" class="alert"></div>

            <!-- Distribution Tables Section -->
            <div id="distributionTables" style="margin-bottom: 30px;"></div>

            <div class="table-container scrollable">
                <table id="tableResults" class="results-table">
                    <thead>
                        <tr>
                            <th>Cust</th>
                            <th>RN(Arr)</th>
                            <th>ArrInt</th>
                            <th>ArrTime</th>
                            <th>Server</th>
                            <th>ServerName</th>
                            <th>RN(Serv)</th>
                            <th>ServTime</th>
                            <th>Start</th>
                            <th>Wait</th>
                            <th>End</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="resultsSection" style="margin-top: 30px;">
                <h2>Performance Measures</h2>
                <div id="queueResults" class="result"></div>
            </div>

        </div> <!-- END REPORT -->

        <div class="button-group">
            <button class="btn btn-secondary" onclick="clearResults()">Clear Results</button>
            <button class="btn btn-primary" onclick="downloadPDF()">Download as PDF</button>
            <button class="btn btn-secondary" onclick="switchTab(0)">Back to Step 1</button>
        </div>
    </div>
</div>

</div>

       <!-- for download pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="../../js/randomNumbers.js"></script>
    <script src="../../js/multipleServer/multiLimitedTime.js"></script>
    <script>
        // ========== Random Number Generation Functions ==========
        
        function switchTableMethod(table, method) {
            // Update tab buttons
            document.querySelectorAll(`#tab${table.charAt(0).toUpperCase() + table.slice(1)}Manual, #tab${table.charAt(0).toUpperCase() + table.slice(1)}Generated`).forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll(`#${table}ManualSection, #${table}GeneratedSection`).forEach(section => section.classList.remove('active'));

            if (method === 'manual') {
                document.getElementById(`tab${table.charAt(0).toUpperCase() + table.slice(1)}Manual`).classList.add('active');
                document.getElementById(`${table}ManualSection`).classList.add('active');
            } else {
                document.getElementById(`tab${table.charAt(0).toUpperCase() + table.slice(1)}Generated`).classList.add('active');
                document.getElementById(`${table}GeneratedSection`).classList.add('active');
            }
        }

        function switchGenMethod(table, method) {
            if (method === 'LCG') {
                document.getElementById(`${table}LcgParams`).classList.remove('hidden');
                document.getElementById(`${table}MidSquareParams`).classList.add('hidden');
            } else {
                document.getElementById(`${table}LcgParams`).classList.add('hidden');
                document.getElementById(`${table}MidSquareParams`).classList.remove('hidden');
            }
        }
        
        function validateRandomNumbers(textarea) {
            updateRandomNumberCounts();
        }
        
        function generateTableRandomNumbers(table) {
            try {
                const method = document.querySelector(`input[name="${table}GenMethod"]:checked`).value;
                const countInput = document.getElementById(table === 'arrival' ? 'genArrCount' : 'genServCount');
                const count = parseInt(countInput.value);

                if (isNaN(count) || count <= 0) {
                    alert(`Please enter a valid number of ${table} random numbers.`);
                    return;
                }

                let numbers = [];

                if (method === 'LCG') {
                    const a = parseFloat(document.getElementById(`${table}LcgA`).value);
                    const c = parseFloat(document.getElementById(`${table}LcgC`).value);
                    const m = parseFloat(document.getElementById(`${table}LcgM`).value);
                    const seed = parseFloat(document.getElementById(`${table}LcgSeed`).value);

                    if (isNaN(a) || isNaN(c) || isNaN(m) || isNaN(seed)) {
                        alert('Please enter all LCG parameters.');
                        return;
                    }

                    const randomsResult = generateLCG(a, c, m, seed, count);
                    numbers = randomsResult.numbers;

                    // Check for cycles and show warnings
                    if (randomsResult.cycleDetected) {
                        const cycleWarning = `${table.charAt(0).toUpperCase() + table.slice(1)}: Cycle detected after ${randomsResult.generatedCount} numbers (cycle length: ${randomsResult.cycleLength}). Please complete the remaining numbers manually.`;
                        alert(cycleWarning);
                    }

                } else if (method === 'MidSquare') {
                    const seed = parseInt(document.getElementById(`${table}MidSquareSeed`).value);

                    if (isNaN(seed) || seed < 1000 || seed > 9999) {
                        alert('Please enter a valid 4-digit seed (1000-9999).');
                        return;
                    }

                    numbers = generateMidSquare(seed, count);
                }

                // Display results
                const textarea = document.getElementById(table === 'arrival' ? 'genArrNumbers' : 'genServNumbers');
                const resultsDiv = document.getElementById(`${table}GeneratedResults`);

                textarea.value = numbers.join(', ');
                resultsDiv.classList.remove('hidden');

            } catch (error) {
                alert('Error generating random numbers: ' + error.message);
            }
        }

        function useGeneratedTableNumbers(table) {
            const textarea = document.getElementById(table === 'arrival' ? 'genArrNumbers' : 'genServNumbers');
            const numbers = textarea.value;

            if (!numbers) {
                alert('Please generate numbers first.');
                return;
            }

            // Parse and populate table
            const nums = numbers.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n >= 0 && n <= 100);
            const tbody = document.getElementById(table === 'arrival' ? 'tbodyRnArr' : 'tbodyRnServ');
            tbody.innerHTML = '';
            nums.forEach(num => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, '${table}')" title="Delete row">üóëÔ∏è</button></td>
                    <td><input type="number" class="table-input" min="0" max="100" step="0.01" value="${num}" placeholder="0-100" onchange="updateRandomNumberCounts()"></td>
                `;
                tbody.appendChild(tr);
            });

            // Update counts and hidden textareas
            updateRandomNumberCounts();

            // Switch to manual tab to show the filled values
            switchTableMethod(table, 'manual');

            alert(`Generated ${table} numbers have been applied to the table.`);
        }
        
        // Initialize counts on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                updateRandomNumberCounts();
                updateServerCount(); // Initialize service tables
            }, 100);
        });
    </script>
</body>
</html>
