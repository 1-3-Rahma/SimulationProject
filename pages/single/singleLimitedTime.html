<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Single-Server Time-Limited Simulation</title>
    <!-- Global layout & buttons -->
    <link rel="stylesheet" href="../../css/main.css">
    <!-- Simulation-specific layout (tables, inputs, etc.) -->
    <link rel="stylesheet" href="../../css/simulation.css">
    <!-- Single-Limited Time specific styles -->
    <link rel="stylesheet" href="../../css/multiLimitedTime.css">
</head>
<body>
<div class="container">
        <button class="btn back-btn" onclick="window.location.href='../../index.html'">‚Üê Back to Main Menu</button>
        
        <h1>Single-Server Time-Limited Simulation</h1>

        <!-- Tabs Navigation -->
        <div class="tabs-nav">
            <button class="tab-btn active" onclick="switchTab(0)">Step 1 ‚Äî Time Limit</button>
            <button class="tab-btn" onclick="switchTab(1)">Step 2 ‚Äî Interarrivals</button>
            <button class="tab-btn" onclick="switchTab(2)">Step 3 ‚Äî Service Times</button>
            <button class="tab-btn" onclick="switchTab(3)">Step 4 ‚Äî Random Numbers</button>
            <button class="tab-btn" onclick="switchTab(4)">Step 5 ‚Äî Simulation Table</button>
        </div>

        <!-- TAB 1: Time Limit -->
        <div id="tab0" class="tab-content active">
            <div class="tab-body">
                <h2>Step 1: Time Limit</h2>
                <p>Set the time limit for the simulation. The simulation will stop when this time limit is reached.</p>
                
                <div class="input-group">
<label>Select Limitation Type:</label>
<select id="limitType">
<option value="arrival">Limited by Arrival Time</option>
<option value="serviceEnd">Limited by Service End Time</option>
<option value="both">Strict Limited (Arrival + Service End)</option>
</select>
</div>

                <div class="input-group">
                    <label>Time Limit:</label>
                    <input type="number" id="timeLimit" min="0.1" step="0.1" placeholder="e.g., 100.0">
                    <small>(Simulation will stop when this time limit is reached)</small>
                </div>

                <button class="btn btn-primary" onclick="nextTab(1)">Next ‚Üí Step 2</button>
            </div>
        </div>

        <!-- TAB 2: Arrivals -->
        <div id="tab1" class="tab-content">
            <div class="tab-body">
                <h2>Step 2: Time Between Arrivals</h2>
                <p>Fill in the table directly with Time and Probability values. Cumulative and Interval will be calculated automatically.</p>
                
                <div class="table-container">
                    <div class="table-controls">
                        <button class="btn-add-row" onclick="addArrivalRow()">Add Row</button>
                        <input type="number" id="arrivalRowCount" min="1" max="50" value="3" placeholder="Rows" style="width: 80px; margin: 0 5px; padding: 5px;">
                        <button class="btn btn-secondary" onclick="generateArrivalRows()">Generate Rows</button>
                    </div>
                    
                    <textarea id="txtArrivals" rows="4" placeholder="Alternative: Enter time,prob (one per line)&#10;1,0.25&#10;2,0.40&#10;3,0.35" style="margin-bottom: 15px; display: none;"></textarea>

                    <h3>Arrival Table (Time | Probability | Cumulative | Interval 01‚Äì100)</h3>
                    <table id="tableArrival" class="editable-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"></th>
                                <th>Time</th>
                                <th>Probability</th>
                                <th>Cumulative</th>
                                <th>Interval</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyArrival">
                            <tr>
                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteArrivalRow(this)" title="Delete row">üóëÔ∏è</button></td>
                                <td><input type="number" class="table-input" step="0.1" min="0" placeholder="Time" onchange="calculateArrivalTable()"></td>
                                <td><input type="number" class="table-input" step="0.01" min="0" max="1" placeholder="Prob" onchange="calculateArrivalTable()"></td>
                                <td class="calculated-cell"></td>
                                <td class="calculated-cell"></td>
                            </tr>
                            <tr>
                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteArrivalRow(this)" title="Delete row">üóëÔ∏è</button></td>
                                <td><input type="number" class="table-input" step="0.1" min="0" placeholder="Time" onchange="calculateArrivalTable()"></td>
                                <td><input type="number" class="table-input" step="0.01" min="0" max="1" placeholder="Prob" onchange="calculateArrivalTable()"></td>
                                <td class="calculated-cell"></td>
                                <td class="calculated-cell"></td>
                            </tr>
                            <tr>
                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteArrivalRow(this)" title="Delete row">üóëÔ∏è</button></td>
                                <td><input type="number" class="table-input" step="0.1" min="0" placeholder="Time" onchange="calculateArrivalTable()"></td>
                                <td><input type="number" class="table-input" step="0.01" min="0" max="1" placeholder="Prob" onchange="calculateArrivalTable()"></td>
                                <td class="calculated-cell"></td>
                                <td class="calculated-cell"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevTab(0)">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="nextTab(2)">Next ‚Üí Step 3</button>
                </div>
            </div>
        </div>

        <!-- TAB 3: Service Times -->
        <div id="tab2" class="tab-content">
            <div class="tab-body">
                <h2>Step 3: Service Times</h2>
                <p>Fill in the table directly with Time and Probability values. Cumulative and Interval will be calculated automatically.</p>
                
                <div class="table-container">
                    <div class="table-controls">
                        <button class="btn-add-row" onclick="addServiceRow()">Add Row</button>
                        <input type="number" id="serviceRowCount" min="1" max="50" value="3" placeholder="Rows" style="width: 80px; margin: 0 5px; padding: 5px;">
                        <button class="btn btn-secondary" onclick="generateServiceRows()">Generate Rows</button>
                    </div>
                    
                    <textarea id="txtService" rows="4" placeholder="Alternative: Enter time,prob (one per line)" style="margin-bottom: 15px; display: none;"></textarea>
                    
                    <h3>Service Time Table (Time | Probability | Cumulative | Interval 01‚Äì100)</h3>
                    <table id="tableService" class="editable-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"></th>
                                <th>Time</th>
                                <th>Probability</th>
                                <th>Cumulative</th>
                                <th>Interval</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyService">
                            <tr>
                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteServiceRow(this)" title="Delete row">üóëÔ∏è</button></td>
                                <td><input type="number" class="table-input" step="0.1" min="0" placeholder="Time" onchange="calculateServiceTable()"></td>
                                <td><input type="number" class="table-input" step="0.01" min="0" max="1" placeholder="Prob" onchange="calculateServiceTable()"></td>
                                <td class="calculated-cell"></td>
                                <td class="calculated-cell"></td>
                            </tr>
                            <tr>
                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteServiceRow(this)" title="Delete row">üóëÔ∏è</button></td>
                                <td><input type="number" class="table-input" step="0.1" min="0" placeholder="Time" onchange="calculateServiceTable()"></td>
                                <td><input type="number" class="table-input" step="0.01" min="0" max="1" placeholder="Prob" onchange="calculateServiceTable()"></td>
                                <td class="calculated-cell"></td>
                                <td class="calculated-cell"></td>
                            </tr>
                            <tr>
                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteServiceRow(this)" title="Delete row">üóëÔ∏è</button></td>
                                <td><input type="number" class="table-input" step="0.1" min="0" placeholder="Time" onchange="calculateServiceTable()"></td>
                                <td><input type="number" class="table-input" step="0.01" min="0" max="1" placeholder="Prob" onchange="calculateServiceTable()"></td>
                                <td class="calculated-cell"></td>
                                <td class="calculated-cell"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevTab(1)">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="nextTab(3)">Next ‚Üí Step 4</button>
                </div>
            </div>
        </div>

        <!-- TAB 4: Random Numbers -->
        <div id="tab3" class="tab-content">
            <div class="tab-body">
                <h2>Step 4: Random Numbers</h2>
                <p>Choose how to provide random numbers for each table: Manual Input, LCG method, or Mid-Square method</p>

                <div class="random-tables-container">
                    <!-- Arrival Random Numbers Table -->
                    <div class="random-table-box">
                        <h4>Arrival Random Numbers (for customers 2..N)</h4>

                        <!-- Method Selection for Arrival -->
                        <div class="method-selection">
                            <div class="method-tabs">
                                <button class="method-tab active" onclick="switchTableMethod('arrival', 'manual')" id="arrival-tab-manual">Manual Input</button>
                                <button class="method-tab" onclick="switchTableMethod('arrival', 'lcg')" id="arrival-tab-lcg">LCG Method</button>
                                <button class="method-tab" onclick="switchTableMethod('arrival', 'midsquare')" id="arrival-tab-midsquare">Mid-Square Method</button>
                            </div>
                        </div>

                        <!-- Manual Input for Arrival -->
                        <div id="arrival-manual-section" class="method-section active">
                            <div class="table-controls">
                                <button class="btn-add-row" onclick="addRandomNumberRow('arrival')">Add Row</button>
                                <input type="number" id="randomArrivalRowCount" min="1" max="100" value="5" placeholder="Rows" style="width: 80px; margin: 0 5px; padding: 5px;">
                                <button class="btn btn-secondary" onclick="generateRandomNumberRows('arrival')">Generate Rows</button>
                                <button class="btn btn-secondary" onclick="updateRandomNumberCounts()">Update Count</button>
                            </div>
                            <div class="table-container">
                                <table id="tableRnArr" class="editable-table random-numbers-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;"></th>
                                            <th>Random Number</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyRnArr">
                                        <tr>
                                            <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'arrival')" title="Delete row">üóëÔ∏è</button></td>
                                            <td><input type="number" class="table-input" min="0" max="100" step="0.01" placeholder="0-100"></td>
                                        </tr>
                                        <tr>
                                            <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'arrival')" title="Delete row">üóëÔ∏è</button></td>
                                            <td><input type="number" class="table-input" min="0" max="100" step="0.01" placeholder="0-100"></td>
                                        </tr>
                                        <tr>
                                            <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'arrival')" title="Delete row">üóëÔ∏è</button></td>
                                            <td><input type="number" class="table-input" min="0" max="100" step="0.01" placeholder="0-100"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <small id="arrivalCount">Count: 3 numbers</small>
                        </div>

                        <!-- LCG Parameters for Arrival -->
                        <div id="arrival-lcg-section" class="method-section">
                            <h5>LCG Parameters for Arrival Numbers</h5>
                            <div class="params-grid">
                                <div class="input-group">
                                    <label>Multiplier (a):</label>
                                    <input type="number" id="arrival-lcg-a" min="0" placeholder="e.g., 1664525">
                                </div>
                                <div class="input-group">
                                    <label>Increment (c):</label>
                                    <input type="number" id="arrival-lcg-c" min="0" placeholder="e.g., 1013904223">
                                </div>
                                <div class="input-group">
                                    <label>Modulus (m):</label>
                                    <input type="number" id="arrival-lcg-m" min="1" placeholder="e.g., 2^32">
                                </div>
                                <div class="input-group">
                                    <label>Initial Seed (Z‚ÇÄ):</label>
                                    <input type="number" id="arrival-lcg-seed" min="0" placeholder="e.g., 12345">
                                </div>
                            </div>
                            <div class="input-group">
                                <label>Number of Random Numbers:</label>
                                <input type="number" id="arrival-lcg-count" min="1" placeholder="e.g., 50">
                            </div>
                            <button class="btn btn-secondary" onclick="generateTableRandomNumbers('arrival', 'lcg')">Generate Arrival Numbers</button>
                        </div>

                        <!-- Mid-Square Parameters for Arrival -->
                        <div id="arrival-midsquare-section" class="method-section">
                            <h5>Mid-Square Parameters for Arrival Numbers</h5>
                            <div class="input-group">
                                <label>Seed (4-digit, 1000-9999):</label>
                                <input type="number" id="arrival-midsquare-seed" min="1000" max="9999" placeholder="e.g., 1234">
                            </div>
                            <div class="input-group">
                                <label>Number of Random Numbers:</label>
                                <input type="number" id="arrival-midsquare-count" min="1" placeholder="e.g., 50">
                            </div>
                            <button class="btn btn-secondary" onclick="generateTableRandomNumbers('arrival', 'midsquare')">Generate Arrival Numbers</button>
                        </div>
                    </div>

                    <!-- Service Random Numbers Table -->
                    <div class="random-table-box">
                        <h4>Service Random Numbers (for all customers)</h4>

                        <!-- Method Selection for Service -->
                        <div class="method-selection">
                            <div class="method-tabs">
                                <button class="method-tab active" onclick="switchTableMethod('service', 'manual')" id="service-tab-manual">Manual Input</button>
                                <button class="method-tab" onclick="switchTableMethod('service', 'lcg')" id="service-tab-lcg">LCG Method</button>
                                <button class="method-tab" onclick="switchTableMethod('service', 'midsquare')" id="service-tab-midsquare">Mid-Square Method</button>
                            </div>
                        </div>

                        <!-- Manual Input for Service -->
                        <div id="service-manual-section" class="method-section active">
                            <div class="table-controls">
                                <button class="btn-add-row" onclick="addRandomNumberRow('service')">Add Row</button>
                                <input type="number" id="randomServiceRowCount" min="1" max="100" value="5" placeholder="Rows" style="width: 80px; margin: 0 5px; padding: 5px;">
                                <button class="btn btn-secondary" onclick="generateRandomNumberRows('service')">Generate Rows</button>
                                <button class="btn btn-secondary" onclick="updateRandomNumberCounts()">Update Count</button>
                            </div>
                            <div class="table-container">
                                <table id="tableRnServ" class="editable-table random-numbers-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;"></th>
                                            <th>Random Number</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyRnServ">
                                        <tr>
                                            <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'service')" title="Delete row">üóëÔ∏è</button></td>
                                            <td><input type="number" class="table-input" min="0" max="100" step="0.01" placeholder="0-100"></td>
                                        </tr>
                                        <tr>
                                            <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'service')" title="Delete row">üóëÔ∏è</button></td>
                                            <td><input type="number" class="table-input" min="0" max="100" step="0.01" placeholder="0-100"></td>
                                        </tr>
                                        <tr>
                                            <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'service')" title="Delete row">üóëÔ∏è</button></td>
                                            <td><input type="number" class="table-input" min="0" max="100" step="0.01" placeholder="0-100"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <small id="serviceCount">Count: 3 numbers</small>
                        </div>

                        <!-- LCG Parameters for Service -->
                        <div id="service-lcg-section" class="method-section">
                            <h5>LCG Parameters for Service Numbers</h5>
                            <div class="params-grid">
                                <div class="input-group">
                                    <label>Multiplier (a):</label>
                                    <input type="number" id="service-lcg-a" min="0" placeholder="e.g., 1664525">
                                </div>
                                <div class="input-group">
                                    <label>Increment (c):</label>
                                    <input type="number" id="service-lcg-c" min="0" placeholder="e.g., 1013904223">
                                </div>
                                <div class="input-group">
                                    <label>Modulus (m):</label>
                                    <input type="number" id="service-lcg-m" min="1" placeholder="e.g., 2^32">
                                </div>
                                <div class="input-group">
                                    <label>Initial Seed (Z‚ÇÄ):</label>
                                    <input type="number" id="service-lcg-seed" min="0" placeholder="e.g., 12345">
                                </div>
                            </div>
                            <div class="input-group">
                                <label>Number of Random Numbers:</label>
                                <input type="number" id="service-lcg-count" min="1" placeholder="e.g., 50">
                            </div>
                            <button class="btn btn-secondary" onclick="generateTableRandomNumbers('service', 'lcg')">Generate Service Numbers</button>
                        </div>

                        <!-- Mid-Square Parameters for Service -->
                        <div id="service-midsquare-section" class="method-section">
                            <h5>Mid-Square Parameters for Service Numbers</h5>
                            <div class="input-group">
                                <label>Seed (4-digit, 1000-9999):</label>
                                <input type="number" id="service-midsquare-seed" min="1000" max="9999" placeholder="e.g., 1234">
                            </div>
                            <div class="input-group">
                                <label>Number of Random Numbers:</label>
                                <input type="number" id="service-midsquare-count" min="1" placeholder="e.g., 50">
                            </div>
                            <button class="btn btn-secondary" onclick="generateTableRandomNumbers('service', 'midsquare')">Generate Service Numbers</button>
                        </div>
                    </div>
                </div>

                <!-- Hidden textareas for backward compatibility -->
                <textarea id="txtRnArr" style="display: none;"></textarea>
                <textarea id="txtRnServ" style="display: none;"></textarea>

                <div class="button-group" style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="runSimulationFromUI()">Run Simulation ‚Üí Show Results (Step 5)</button>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevTab(2)">‚Üê Back</button>
                </div>
            </div>
</div>

        <!-- TAB 5: Results -->
<div id="tab4" class="tab-content">
    <div class="tab-body">
        <h2>Step 5: Simulation Results</h2>

        <!-- ‚úÖ INCLUDED IN PDF -->
        <div id="report">

            <div id="timeLimitInfo" class="alert"></div>

            <!-- Distribution Tables Section -->
            <div id="distributionTables" style="margin-bottom: 30px;"></div>

            <div class="table-container scrollable">
                <table id="tableResults" class="results-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Arrival RN</th>
                            <th>Interarrival Time</th>
                            <th>Arrival Time</th>
                            <th>Service RN</th>
                            <th>Service Time</th>
                            <th>Time Service Begins</th>
                            <th>Time Service Ends</th>
                            <th>Waiting Time in Queue</th>
                            <th>Time in System</th>
                            <th>Idle Time of Server</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="resultsSection" style="margin-top: 30px;">
                <h2>Performance Measures</h2>
                <div id="queueResults" class="result"></div>
            </div>

        </div> <!-- END REPORT -->

        <div class="button-group">
            <button class="btn btn-secondary" onclick="clearResults()">Clear Results</button>
            <button class="btn btn-primary" onclick="downloadPDF()">Download as PDF</button>
            <button class="btn btn-secondary" onclick="switchTab(0)">Back to Step 1</button>
        </div>
    </div>
</div>

</div>

        <!-- for download pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="../../js/randomNumbers.js"></script>
    <script src="../../js/singleServer/singleLimitedTime.js"></script>
    <script>
        // ========== Random Number Generation Functions ==========

        function switchTableMethod(tableType, method) {
            // Remove active class from all tabs for this table
            document.querySelectorAll(`#${tableType}-tab-manual, #${tableType}-tab-lcg, #${tableType}-tab-midsquare`).forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all sections for this table
            document.querySelectorAll(`#${tableType}-manual-section, #${tableType}-lcg-section, #${tableType}-midsquare-section`).forEach(section => {
                section.classList.remove('active');
            });

            // Add active class to selected tab and section
            document.getElementById(`${tableType}-tab-${method}`).classList.add('active');
            document.getElementById(`${tableType}-${method}-section`).classList.add('active');
        }

        function generateTableRandomNumbers(tableType, method) {
            try {
                const countInputId = `${tableType}-${method}-count`;
                const count = parseInt(document.getElementById(countInputId).value);

                if (isNaN(count) || count <= 0) {
                    alert(`Please enter a valid number of random numbers for ${tableType}.`);
                    return;
                }

                let numbers = [];

                if (method === 'lcg') {
                    const a = parseFloat(document.getElementById(`${tableType}-lcg-a`).value);
                    const c = parseFloat(document.getElementById(`${tableType}-lcg-c`).value);
                    const m = parseFloat(document.getElementById(`${tableType}-lcg-m`).value);
                    const seed = parseFloat(document.getElementById(`${tableType}-lcg-seed`).value);

                    if (isNaN(a) || isNaN(c) || isNaN(m) || isNaN(seed)) {
                        alert('Please enter all LCG parameters.');
                        return;
                    }

                    numbers = generateLCG(a, c, m, seed, count);

                } else if (method === 'midsquare') {
                    const seed = parseInt(document.getElementById(`${tableType}-midsquare-seed`).value);

                    if (isNaN(seed) || seed < 1000 || seed > 9999) {
                        alert('Please enter a valid 4-digit seed (1000-9999).');
                        return;
                    }

                    numbers = generateMidSquare(seed, count);
                }

                // Populate the table with generated numbers
                const tbodyId = tableType === 'arrival' ? 'tbodyRnArr' : 'tbodyRnServ';
                const tbody = document.getElementById(tbodyId);
                tbody.innerHTML = '';

                numbers.forEach(num => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, '${tableType}')" title="Delete row">üóëÔ∏è</button></td>
                        <td><input type="number" class="table-input" min="0" max="100" step="0.01" value="${num}" placeholder="0-100" onchange="updateRandomNumberCounts()"></td>
                    `;
                    tbody.appendChild(tr);
                });

                // Update counts and switch to manual view
                updateRandomNumberCounts();
                switchTableMethod(tableType, 'manual');

                alert(`${tableType.charAt(0).toUpperCase() + tableType.slice(1)} numbers generated successfully and applied to the table.`);

            } catch (error) {
                alert('Error generating random numbers: ' + error.message);
            }
        }

        function validateRandomNumbers(textarea) {
            // This function is kept for backward compatibility but not actively used
            // Random numbers are now managed through table cells
            updateRandomNumberCounts();
        }

        // Initialize counts on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                updateRandomNumberCounts();
            }, 100);
        });
    </script>
</body>
</html>
