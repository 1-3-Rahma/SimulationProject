<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Single-Server Time-Limited Simulation</title>
    <!-- Global layout & buttons -->
    <link rel="stylesheet" href="../../css/main.css">
    <!-- Simulation-specific layout (tables, inputs, etc.) -->
    <link rel="stylesheet" href="../../css/simulation.css">
    <!-- Single-Limited Time specific styles -->
    <link rel="stylesheet" href="../../css/multiLimitedTime.css">
</head>
<body>
<div class="container">
        <button class="btn back-btn" onclick="window.location.href='../../mainPage/home.html'">‚Üê Back to Main Menu</button>
        
        <h1>Single-Server Time-Limited Simulation</h1>

        <!-- Tabs Navigation -->
        <div class="tabs-nav">
            <button class="tab-btn active" onclick="switchTab(0)">Step 1 ‚Äî Time Limit</button>
            <button class="tab-btn" onclick="switchTab(1)">Step 2 ‚Äî Interarrivals</button>
            <button class="tab-btn" onclick="switchTab(2)">Step 3 ‚Äî Service Times</button>
            <button class="tab-btn" onclick="switchTab(3)">Step 4 ‚Äî Random Numbers</button>
            <button class="tab-btn" onclick="switchTab(4)">Step 5 ‚Äî Simulation Table</button>
        </div>

        <!-- TAB 1: Time Limit -->
        <div id="tab0" class="tab-content active">
            <div class="tab-body">
                <h2>Step 1: Time Limit</h2>
                <p>Set the time limit for the simulation. The simulation will stop when this time limit is reached.</p>
                
                <div class="input-group">
<label>Select Limitation Type:</label>
<select id="limitType">
<option value="arrival">Limited by Arrival Time</option>
<option value="serviceEnd">Limited by Service End Time</option>
<option value="both">Strict Limited (Arrival + Service End)</option>
</select>
</div>

                <div class="input-group">
                    <label>Time Limit:</label>
                    <input type="number" id="timeLimit" min="0.1" step="0.1" placeholder="e.g., 100.0">
                    <small>(Simulation will stop when this time limit is reached)</small>
                </div>

                <button class="btn btn-primary" onclick="nextTab(1)">Next ‚Üí Step 2</button>
            </div>
        </div>

        <!-- TAB 2: Arrivals -->
        <div id="tab1" class="tab-content">
            <div class="tab-body">
                <h2>Step 2: Time Between Arrivals</h2>
                <p>Fill in the table directly with Time and Probability values. Cumulative and Interval will be calculated automatically.</p>
                
                <div class="table-container">
                    <div class="table-controls">
                        <button class="btn-add-row" onclick="addArrivalRow()">Add Row</button>
                        <input type="number" id="arrivalRowCount" min="1" max="50" value="3" placeholder="Rows" style="width: 80px; margin: 0 5px; padding: 5px;">
                        <button class="btn btn-secondary" onclick="generateArrivalRows()">Generate Rows</button>
                    </div>
                    
                    <textarea id="txtArrivals" rows="4" placeholder="Alternative: Enter time,prob (one per line)&#10;1,0.25&#10;2,0.40&#10;3,0.35" style="margin-bottom: 15px; display: none;"></textarea>

                    <h3>Arrival Table (Time | Probability | Cumulative | Interval 01‚Äì100)</h3>
                    <table id="tableArrival" class="editable-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"></th>
                                <th>Time</th>
                                <th>Probability</th>
                                <th>Cumulative</th>
                                <th>Interval</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyArrival">
                            <tr>
                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteArrivalRow(this)" title="Delete row">üóëÔ∏è</button></td>
                                <td><input type="number" class="table-input" step="0.1" min="0" placeholder="Time" onchange="calculateArrivalTable()"></td>
                                <td><input type="number" class="table-input" step="0.01" min="0" max="1" placeholder="Prob" onchange="calculateArrivalTable()"></td>
                                <td class="calculated-cell"></td>
                                <td class="calculated-cell"></td>
                            </tr>
                            <tr>
                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteArrivalRow(this)" title="Delete row">üóëÔ∏è</button></td>
                                <td><input type="number" class="table-input" step="0.1" min="0" placeholder="Time" onchange="calculateArrivalTable()"></td>
                                <td><input type="number" class="table-input" step="0.01" min="0" max="1" placeholder="Prob" onchange="calculateArrivalTable()"></td>
                                <td class="calculated-cell"></td>
                                <td class="calculated-cell"></td>
                            </tr>
                            <tr>
                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteArrivalRow(this)" title="Delete row">üóëÔ∏è</button></td>
                                <td><input type="number" class="table-input" step="0.1" min="0" placeholder="Time" onchange="calculateArrivalTable()"></td>
                                <td><input type="number" class="table-input" step="0.01" min="0" max="1" placeholder="Prob" onchange="calculateArrivalTable()"></td>
                                <td class="calculated-cell"></td>
                                <td class="calculated-cell"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevTab(0)">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="nextTab(2)">Next ‚Üí Step 3</button>
                </div>
            </div>
        </div>

        <!-- TAB 3: Service Times -->
        <div id="tab2" class="tab-content">
            <div class="tab-body">
                <h2>Step 3: Service Times</h2>
                <p>Fill in the table directly with Time and Probability values. Cumulative and Interval will be calculated automatically.</p>
                
                <div class="table-container">
                    <div class="table-controls">
                        <button class="btn-add-row" onclick="addServiceRow()">Add Row</button>
                        <input type="number" id="serviceRowCount" min="1" max="50" value="3" placeholder="Rows" style="width: 80px; margin: 0 5px; padding: 5px;">
                        <button class="btn btn-secondary" onclick="generateServiceRows()">Generate Rows</button>
                    </div>
                    
                    <textarea id="txtService" rows="4" placeholder="Alternative: Enter time,prob (one per line)" style="margin-bottom: 15px; display: none;"></textarea>
                    
                    <h3>Service Time Table (Time | Probability | Cumulative | Interval 01‚Äì100)</h3>
                    <table id="tableService" class="editable-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"></th>
                                <th>Time</th>
                                <th>Probability</th>
                                <th>Cumulative</th>
                                <th>Interval</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyService">
                            <tr>
                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteServiceRow(this)" title="Delete row">üóëÔ∏è</button></td>
                                <td><input type="number" class="table-input" step="0.1" min="0" placeholder="Time" onchange="calculateServiceTable()"></td>
                                <td><input type="number" class="table-input" step="0.01" min="0" max="1" placeholder="Prob" onchange="calculateServiceTable()"></td>
                                <td class="calculated-cell"></td>
                                <td class="calculated-cell"></td>
                            </tr>
                            <tr>
                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteServiceRow(this)" title="Delete row">üóëÔ∏è</button></td>
                                <td><input type="number" class="table-input" step="0.1" min="0" placeholder="Time" onchange="calculateServiceTable()"></td>
                                <td><input type="number" class="table-input" step="0.01" min="0" max="1" placeholder="Prob" onchange="calculateServiceTable()"></td>
                                <td class="calculated-cell"></td>
                                <td class="calculated-cell"></td>
                            </tr>
                            <tr>
                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteServiceRow(this)" title="Delete row">üóëÔ∏è</button></td>
                                <td><input type="number" class="table-input" step="0.1" min="0" placeholder="Time" onchange="calculateServiceTable()"></td>
                                <td><input type="number" class="table-input" step="0.01" min="0" max="1" placeholder="Prob" onchange="calculateServiceTable()"></td>
                                <td class="calculated-cell"></td>
                                <td class="calculated-cell"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevTab(1)">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="nextTab(3)">Next ‚Üí Step 4</button>
                </div>
            </div>
        </div>

        <!-- TAB 4: Random Numbers -->
        <div id="tab3" class="tab-content">
            <div class="tab-body">
                <h2>Step 4: Random Numbers</h2>
                <p>Choose how to provide random numbers: Manual Input or Generated (LCG/Mid-Square)</p>
                
                <!-- Random Number Method Selection -->
                <div class="random-method-selector">
                    <div class="method-tabs">
                        <button class="method-tab active" onclick="switchRandomMethod('manual')" id="tabManual">Manual Input</button>
                        <button class="method-tab" onclick="switchRandomMethod('generated')" id="tabGenerated">Generated</button>
                    </div>
                    
                    <!-- Manual Input Section -->
                    <div id="manualSection" class="method-section active">
                        <h3>Manual Random Number Input</h3>
                        <p>Enter random numbers between 1 and 100 directly in the table cells</p>
                        
                        <div class="random-tables-container">
                            <div class="random-table-box">
                                <h4>Arrival Random Numbers (for customers 2..N)</h4>
                                <div class="table-controls">
                                    <button class="btn-add-row" onclick="addRandomNumberRow('arrival')"> Add Row</button>
                                    <input type="number" id="randomArrivalRowCount" min="1" max="100" value="5" placeholder="Rows" style="width: 80px; margin: 0 5px; padding: 5px;">
                                    <button class="btn btn-secondary" onclick="generateRandomNumberRows('arrival')">Generate Rows</button>
                                    <button class="btn btn-secondary" onclick="updateRandomNumberCounts()">Update Count</button>
                                </div>
                                <div class="table-container">
                                    <table id="tableRnArr" class="editable-table random-numbers-table">
                                        <thead>
                                            <tr>
                                                <th style="width: 50px;"></th>
                                                <th>Random Number</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbodyRnArr">
                                            <tr>
                                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'arrival')" title="Delete row">üóëÔ∏è</button></td>
                                                <td><input type="number" class="table-input" min="1" max="100" placeholder="1-100"></td>
                                            </tr>
                                            <tr>
                                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'arrival')" title="Delete row">üóëÔ∏è</button></td>
                                                <td><input type="number" class="table-input" min="1" max="100" placeholder="1-100"></td>
                                            </tr>
                                            <tr>
                                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'arrival')" title="Delete row">üóëÔ∏è</button></td>
                                                <td><input type="number" class="table-input" min="1" max="100" placeholder="1-100"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <small id="arrivalCount">Count: 3 numbers</small>
                            </div>
                            
                            <div class="random-table-box">
                                <h4>Service Random Numbers (for all customers)</h4>
                                <div class="table-controls">
                                    <button class="btn-add-row" onclick="addRandomNumberRow('service')">Add Row</button>
                                    <input type="number" id="randomServiceRowCount" min="1" max="100" value="5" placeholder="Rows" style="width: 80px; margin: 0 5px; padding: 5px;">
                                    <button class="btn btn-secondary" onclick="generateRandomNumberRows('service')">Generate Rows</button>
                                    <button class="btn btn-secondary" onclick="updateRandomNumberCounts()">Update Count</button>
                                </div>
                                <div class="table-container">
                                    <table id="tableRnServ" class="editable-table random-numbers-table">
                                        <thead>
                                            <tr>
                                                <th style="width: 50px;"></th>
                                                <th>Random Number</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbodyRnServ">
                                            <tr>
                                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'service')" title="Delete row">üóëÔ∏è</button></td>
                                                <td><input type="number" class="table-input" min="1" max="100" placeholder="1-100"></td>
                                            </tr>
                                            <tr>
                                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'service')" title="Delete row">üóëÔ∏è</button></td>
                                                <td><input type="number" class="table-input" min="1" max="100" placeholder="1-100"></td>
                                            </tr>
                                            <tr>
                                                <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'service')" title="Delete row">üóëÔ∏è</button></td>
                                                <td><input type="number" class="table-input" min="1" max="100" placeholder="1-100"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <small id="serviceCount">Count: 3 numbers</small>
                            </div>
                        </div>
                        
                        <!-- Hidden textareas for backward compatibility -->
                        <textarea id="txtRnArr" style="display: none;"></textarea>
                        <textarea id="txtRnServ" style="display: none;"></textarea>
                    </div>
                    
                    <!-- Generated Section -->
                    <div id="generatedSection" class="method-section">
                        <h3>Generate Random Numbers</h3>
                        <p>Choose a generation method and parameters</p>
                        
                        <div class="generation-method-selector">
                            <label class="radio-label">
                                <input type="radio" name="genMethod" value="LCG" checked onchange="switchGenMethod('LCG')">
                                <span>Linear Congruential Generator (LCG)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="genMethod" value="MidSquare" onchange="switchGenMethod('MidSquare')">
                                <span>Mid-Square Method</span>
                            </label>
                        </div>
                        
                        <!-- LCG Parameters -->
                        <div id="lcgParams" class="gen-params">
                            <h4>LCG Parameters</h4>
                            <div class="params-grid">
                                <div class="input-group">
                                    <label>Multiplier (a):</label>
                                    <input type="number" id="lcgA" min="0" placeholder="e.g., 1664525">
                                </div>
                                <div class="input-group">
                                    <label>Increment (c):</label>
                                    <input type="number" id="lcgC" min="0" placeholder="e.g., 1013904223">
                                </div>
                                <div class="input-group">
                                    <label>Modulus (m):</label>
                                    <input type="number" id="lcgM" min="1" placeholder="e.g., 2^32">
                                </div>
                                <div class="input-group">
                                    <label>Initial Seed (Z‚ÇÄ):</label>
                                    <input type="number" id="lcgSeed" min="0" placeholder="e.g., 12345">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mid-Square Parameters -->
                        <div id="midSquareParams" class="gen-params hidden">
                            <h4>Mid-Square Parameters</h4>
                            <div class="input-group">
                                <label>Seed (4-digit, 1000-9999):</label>
                                <input type="number" id="midSquareSeed" min="1000" max="9999" placeholder="e.g., 1234">
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label>Number of Arrival Random Numbers:</label>
                            <input type="number" id="genArrCount" min="1" placeholder="e.g., 50">
                            <small>For customers 2..N (recommended: enough for time limit)</small>
                        </div>
                        
                        <div class="input-group">
                            <label>Number of Service Random Numbers:</label>
                            <input type="number" id="genServCount" min="1" placeholder="e.g., 50">
                            <small>For all customers (recommended: enough for time limit)</small>
                        </div>
                        
                        <button class="btn btn-secondary" onclick="generateRandomNumbers()">Generate Random Numbers</button>
                        
                        <div id="generatedResults" class="generated-results hidden">
                            <h4>Generated Numbers</h4>
                            <div class="results-display">
                                <div>
                                    <strong>Arrival Numbers:</strong>
                                    <textarea id="genArrNumbers" rows="3" readonly></textarea>
                                </div>
                                <div>
                                    <strong>Service Numbers:</strong>
                                    <textarea id="genServNumbers" rows="3" readonly></textarea>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="useGeneratedNumbers()">Use These Numbers</button>
                        </div>
                    </div>
                </div>

                <div class="button-group" style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="runSimulationFromUI()">Run Simulation ‚Üí Show Results (Step 5)</button>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevTab(2)">‚Üê Back</button>
                </div>
            </div>
</div>

        <!-- TAB 5: Results -->
<div id="tab4" class="tab-content">
    <div class="tab-body">
        <h2>Step 5: Simulation Results</h2>

        <!-- ‚úÖ INCLUDED IN PDF -->
        <div id="report">

            <div id="timeLimitInfo" class="alert"></div>

            <!-- Distribution Tables Section -->
            <div id="distributionTables" style="margin-bottom: 30px;"></div>

            <div class="table-container scrollable">
                <table id="tableResults" class="results-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Interarrival Time</th>
                            <th>Arrival Time</th>
                            <th>Service Time</th>
                            <th>Time Service Begins</th>
                            <th>Time Service Ends</th>
                            <th>Waiting Time in Queue</th>
                            <th>Time in System</th>
                            <th>Idle Time of Server</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="resultsSection" style="margin-top: 30px;">
                <h2>Performance Measures</h2>
                <div id="queueResults" class="result"></div>
            </div>

        </div> <!-- END REPORT -->

        <div class="button-group">
            <button class="btn btn-secondary" onclick="clearResults()">Clear Results</button>
            <button class="btn btn-primary" onclick="downloadPDF()">Download as PDF</button>
            <button class="btn btn-secondary" onclick="switchTab(0)">Back to Step 1</button>
        </div>
    </div>
</div>

</div>

        <!-- for download pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="../../js/randomNumbers.js"></script>
    <script src="../../js/singleServer/singleLimitedTime.js"></script>
    <script>
        // ========== Random Number Generation Functions ==========
        
        function switchRandomMethod(method) {
            document.querySelectorAll('.method-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.method-section').forEach(section => section.classList.remove('active'));
            
            if (method === 'manual') {
                document.getElementById('tabManual').classList.add('active');
                document.getElementById('manualSection').classList.add('active');
            } else {
                document.getElementById('tabGenerated').classList.add('active');
                document.getElementById('generatedSection').classList.add('active');
            }
        }
        
        function switchGenMethod(method) {
            if (method === 'LCG') {
                document.getElementById('lcgParams').classList.remove('hidden');
                document.getElementById('midSquareParams').classList.add('hidden');
            } else {
                document.getElementById('lcgParams').classList.add('hidden');
                document.getElementById('midSquareParams').classList.remove('hidden');
            }
        }
        
        function validateRandomNumbers(textarea) {
            updateRandomNumberCounts();
        }
        
        function generateRandomNumbers() {
            try {
                const method = document.querySelector('input[name="genMethod"]:checked').value;
                const arrCount = parseInt(document.getElementById('genArrCount').value);
                const servCount = parseInt(document.getElementById('genServCount').value);
                
                if (isNaN(arrCount) || arrCount <= 0) {
                    alert('Please enter a valid number of arrival random numbers.');
                    return;
                }
                
                if (isNaN(servCount) || servCount <= 0) {
                    alert('Please enter a valid number of service random numbers.');
                    return;
                }
                
                let arrNumbers = [];
                let servNumbers = [];
                
                if (method === 'LCG') {
                    const a = parseFloat(document.getElementById('lcgA').value);
                    const c = parseFloat(document.getElementById('lcgC').value);
                    const m = parseFloat(document.getElementById('lcgM').value);
                    const seed = parseFloat(document.getElementById('lcgSeed').value);
                    
                    if (isNaN(a) || isNaN(c) || isNaN(m) || isNaN(seed)) {
                        alert('Please enter all LCG parameters.');
                        return;
                    }
                    
                    const arrRandoms = generateLCG(a, c, m, seed, arrCount);
                    const servRandoms = generateLCG(a, c, m, seed + arrCount, servCount);
                    
                    // Convert 0-1 to 1-100 range
                    arrNumbers = arrRandoms.map(n => Math.floor(n * 100) + 1);
                    servNumbers = servRandoms.map(n => Math.floor(n * 100) + 1);
                    
                } else if (method === 'MidSquare') {
                    const seed = parseInt(document.getElementById('midSquareSeed').value);
                    
                    if (isNaN(seed) || seed < 1000 || seed > 9999) {
                        alert('Please enter a valid 4-digit seed (1000-9999).');
                        return;
                    }
                    
                    const arrRandoms = generateMidSquare(seed, arrCount);
                    const servRandoms = generateMidSquare(seed + 1000, servCount);
                    
                    // Convert 0-1 to 1-100 range
                    arrNumbers = arrRandoms.map(n => Math.floor(n * 100) + 1);
                    servNumbers = servRandoms.map(n => Math.floor(n * 100) + 1);
                }
                
                // Display results
                document.getElementById('genArrNumbers').value = arrNumbers.join(', ');
                document.getElementById('genServNumbers').value = servNumbers.join(', ');
                document.getElementById('generatedResults').classList.remove('hidden');
                
            } catch (error) {
                alert('Error generating random numbers: ' + error.message);
            }
        }
        
        function useGeneratedNumbers() {
            const arrNumbers = document.getElementById('genArrNumbers').value;
            const servNumbers = document.getElementById('genServNumbers').value;
            
            if (!arrNumbers || !servNumbers) {
                alert('Please generate numbers first.');
                return;
            }
            
            // Parse and populate arrival table
            const arrNums = arrNumbers.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 100);
            const tbodyArr = document.getElementById('tbodyRnArr');
            tbodyArr.innerHTML = '';
            arrNums.forEach(num => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'arrival')" title="Delete row">üóëÔ∏è</button></td>
                    <td><input type="number" class="table-input" min="1" max="100" value="${num}" placeholder="1-100" onchange="updateRandomNumberCounts()"></td>
                `;
                tbodyArr.appendChild(tr);
            });
            
            // Parse and populate service table
            const servNums = servNumbers.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 100);
            const tbodyServ = document.getElementById('tbodyRnServ');
            tbodyServ.innerHTML = '';
            servNums.forEach(num => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="action-cell"><button class="btn-delete-row" onclick="deleteRandomNumberRow(this, 'service')" title="Delete row">üóëÔ∏è</button></td>
                    <td><input type="number" class="table-input" min="1" max="100" value="${num}" placeholder="1-100" onchange="updateRandomNumberCounts()"></td>
                `;
                tbodyServ.appendChild(tr);
            });
            
            // Update counts and hidden textareas
            updateRandomNumberCounts();
            
            // Switch to manual tab to show the filled values
            switchRandomMethod('manual');
            
            alert('Generated numbers have been applied to the tables.');
        }
        
        // Initialize counts on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                updateRandomNumberCounts();
            }, 100);
        });
    </script>
</body>
</html>
